<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Información Personal</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav>
    <div class="barra-menu">
        <h1>Systemsware</h1>
    </div>
    <div class="nav-link">
      <a href="servicio.html">Inicio</a>
      <a href="chatbot.html">Chatbot</a>
      <a href="generar-reporte.html">Reportes</a>
      <a href="perfil.html" class="seleccionado">Mi perfil</a>
    </div>
  </nav>

  <main>
    <div class="profile-card">

      <div class="card-header">
        <div class="avatar-ring">
          <div class="avatar-placeholder">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"/>
            </svg>
          </div>
        </div>
        <div class="user-name" id="display-name">Usuario</div>
        <div class="user-email" id="display-email">correo@ejemplo.com</div>
      </div>

      <div class="card-body">
        <div class="section-label">Editar información</div>
        <form id="updateForm" class="info-list">
          <div class="info-row">
            <label class="info-label" for="nombre">Nombre</label>
            <input class="info-value" id="nombre" type="text" />
          </div>
          <div class="info-row">
            <label class="info-label" for="correo">Correo</label>
            <input class="info-value" id="correo" type="email" />
          </div>
          <div class="info-row">
            <label class="info-label" for="contrasena">Nueva contraseña</label>
            <input class="info-value" id="contrasena" type="password" placeholder="Dejar vacío para no cambiar" />
          </div>
          <div class="info-row">
            <label class="info-label" for="contrasena_confirm">Repetir contraseña</label>
            <input class="info-value" id="contrasena_confirm" type="password" />
          </div>
          <div class="info-row">
            <button type="submit">Guardar cambios</button>
          </div>
          <div id="update-msg" style="color:green;margin-top:8px"></div>
        </form>
      </div>

    </div>
  </main>
<script>
async function apiFetch(path, opts={}){
  const token = localStorage.getItem('token');
  const headers = opts.headers || {};
  headers['Content-Type'] = headers['Content-Type'] || 'application/json';
  if (token) headers['Authorization'] = 'Bearer ' + token;
  const res = await fetch(path, Object.assign({}, opts, { headers }));
  return res;
}

async function loadProfile(){
  try{
    const res = await apiFetch('/api/me', { method: 'GET' });
    if (!res.ok) throw new Error('No autorizado');
    const data = await res.json();
    const user = data.user;
    document.getElementById('display-name').textContent = user.nombre_usuario || 'Usuario';
    document.getElementById('display-email').textContent = user.email || '';
    document.getElementById('nombre').value = user.nombre_usuario || '';
    document.getElementById('correo').value = user.email || '';
  }catch(err){
    console.error(err);
    document.getElementById('update-msg').textContent = 'Debe iniciar sesión para editar.';
  }
}

document.getElementById('updateForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const nombre = document.getElementById('nombre').value.trim();
  const correo = document.getElementById('correo').value.trim();
  const contrasena = document.getElementById('contrasena').value;
  const contrasena_confirm = document.getElementById('contrasena_confirm').value;
  const msg = document.getElementById('update-msg');
  msg.style.color = 'red';
  msg.textContent = '';

  if (contrasena || contrasena_confirm){
    if (contrasena.length < 6){ msg.textContent = 'Contraseña mínimo 6 caracteres.'; return; }
    if (contrasena !== contrasena_confirm){ msg.textContent = 'Las contraseñas no coinciden.'; return; }
  }

  try{
    const body = {};
    if (nombre) body.nombre = nombre;
    if (correo) body.correo = correo;
    if (contrasena) body.contrasena = contrasena;

    const res = await apiFetch('/api/me', { method: 'PATCH', body: JSON.stringify(body) });
    const data = await res.json();
    if (!res.ok) { msg.textContent = data.error || 'Error al actualizar'; return; }
    msg.style.color = 'green';
    msg.textContent = 'Perfil actualizado.';
    document.getElementById('display-name').textContent = data.user.nombre_usuario || nombre;
    document.getElementById('display-email').textContent = data.user.email || correo;
    document.getElementById('contrasena').value = '';
    document.getElementById('contrasena_confirm').value = '';
  }catch(err){
    console.error(err);
    msg.textContent = 'Error de red';
  }
});

loadProfile();
</script>
</body>
</html>